<html>
<head>
<title>Kraplow!</title>
<style>
borders_on{border:1px solid #0F0 !important;}
</style>
</head>
<body onload="timedCount();">
<div>
<h1>Kraplow!</h1>
<div id="gameSetup"></div>
<div id="gameMessages" style="height:200px; display:none; border:1px solid #000;"></div>
<div id="gameState"></div>
<div id="gameInfo">
	<p>Kraplow! An unofficial HTML/AJAX version of Bang!</p>
	<p>Want to play Bang! but not enough people to play with?</p>
	<p>
	<ol>
	<li>Create a game(If no games) <img src="ok.png" width="20"> (games removed once started or abandoned for 20 mintues)</li>
	<li>Join a game <img src="join.png" width="20"> (Use multiple browser to join multiple games, or the same game multiple times)</li>
	<li>Wait for other players to join that game (4 - 7 player games) <img src="player.png" width="20"><img src="player.png" width="20"><img src="player.png" width="20"><img src="player.png" width="20"> - <img src="player.png" width="20"><img src="player.png" width="20"><img src="player.png" width="20"><img src="player.png" width="20"><img src="player.png" width="20"><img src="player.png" width="20"><img src="player.png" width="20"></li>
	<li>Start the game <img src="card.png" width="20"> </li>
	<li>Play cards <img src="cardface.png" width="20"> (3 minutes without interaction - game will timeout)</li>
	<li>When game is over return to this lobby</li>
	</ol>
	</p>
	<p>
	Buy the physical card game
	<ul>
	<li><a href="http://well.ca/brand/bang-card-game.html">Well.ca(Canada/USA)</a></li>
	<li><a href="http://www.dvgiochi.com/?lang=eng">gV Goichi</a></li>
	<li><a href="http://www.amazon.com/gp/product/B001RU7UNW">amazon</a></li>
	</ul>
	</p>
	<p>
	Other Bang! implementations
	<ul>
	<li><a href="http://www.bangvideogame.com/">Official Bang! Video Game</li>
	<li><a href="http://boardgamingonlinetheindex.wordpress.com/2009/07/24/bang-online/">Bang! Online at Vassal</a></li>
	<li><a href="http://bangbeta.neuralfirings.com/">Bang! at neuralfirings</a></li>
	<li><a href="http://code.google.com/p/kbang/">KBang</a></li>
	</ul>
	</p>
	<p><a href="http://www.dvgiochi.com/giochi/bang/?id=1&lang=eng">Bang</a> <a href="http://www.davincigames.net/bang/bang_rules.pdf">Rules</a> <a href="http://www.davincigames.net/bang/faq/bang_faq_eng.pdf">FAQ</a> <a href="http://bangcardgame.blogspot.ca/">Blog</a></p>
	<p><a href="http://174.94.63.5/bangs/bang.html">Project Info, Source Code</a></p>
	<p>Any suggestions on how to improve the game, or bugs would be greatly appreciated.</p>
	<p>Christopher Gordon Carr</p>
	<p><a href="mailto:ccarrster@gmail.com">ccarrster@gmail.com</a></p>
</div>
<div id="chatInput"><form onSubmit="sendChat(getServletUrl(), parseSendChat, document.getElementById('chatinput').value); document.getElementById('chatinput').value = ''; return false;">Chat: <input type="text" id="chatinput"><input type="button" value="Send" onClick="sendChat(getServletUrl(), parseSendChat, document.getElementById('chatinput').value); document.getElementById('chatinput').value = '';"></form></div>
<div id="chatLog"></div>
<div id="gameLog"></div>
<div id="showLegend" style="color:blue; text-decoration:underline" onClick="document.getElementById('legend').style.display='block'; document.getElementById('showLegend').style.display='none';">Show Legend</div>
<div id="legend" style="display:none;">
<h2>Legend</h2>
<div style="color:blue; text-decoration:underline" onClick="document.getElementById('legend').style.display='none'; document.getElementById('showLegend').style.display='block';">Hide Legend</div>
<h2>Roles</h2>
<ol>
<li>Sheriff <img src="sheriff.png"></li>
<li>Deputy <img src="deputy.png"></li>
<li>Outlaw <img src="outlaw.png"></li>
<li>Renegade <img src="renegade.png"></li>
</ol>
<h2>Health</h2>
<ol>
<li>Heath <img src="vbullet.png"></li>
<li>Lost Health <img src="vemptybullet.png"></li>
</ol>
<h2>Figures</h2>
<ol>
<li>Bart Cassidy <img src="bartcassidy.png"></li>
<li>Black Jack <img src="blackjack.png"></li>
<li>Calamity Janet <img src="calamityjanet.png"></li>
<li>El Gringo <img src="elgringo.png"></li>
<li>Jesse Jones <img src="jessejones.png"></li>
<li>Joudonais <img src="jourdonnais.png"></li>
<li>Kit Carlson <img src="kitcarlson.png"></li>
<li>Lucky Duke <img src="luckyduke.png"></li>
<li>Paul Regret <img src="paulregret.png"></li>
<li>Pedro Ramierz <img src="pedroramierz.png"></li>
<li>Rose Doolan <img src="rosedoolan.png"></li>
<li>Sid Ketchum <img src="sidketchum.png"></li>
<li>Slab The Killer <img src="slabthekiller.png"></li>
<li>Suzy Lafayette<img src="suzylafayette.png"></li>
</ol>
<h2>Suits</h2>
<ol>
<li>Hearts <img src="hearts.png"></li>
<li>Diamonds <img src="diamonds.png"></li>
<li>Clubs <img src="clubs.png"></li>
<li>Spades <img src="spades.png"></li>
</ol>
<h2>Guns</h2>
<ol>
<li>Volcanic <img src="volcanic.png"></li>
<li>Schofield <img src="schofield.png"></li>
<li>Remington <img src="remington.png"></li>
<li>Winchester <img src="winchester.png"></li>
<li>Rev. Carbine <img src="carbine.png"></li>
</ol>
<h2>Items</h2>
<ol>
<li>Appaloosa <img src="appaloosa.png"></li>
<li>Barrel <img src="barrel.png"></li>
<li>Dynamite <img src="dynamite.png"></li>
<li>Mustang <img src="mustang.png"></li>
<li>Jail <img src="jail.png"></li>
</ol>
<h2>Play Cards</h2>
<ol>
<li>Bang <img src="bang.png"></li>
<li>Beer <img src="beer.png"></li>
<li>Cat Balou <img src="catbalou.png"></li>
<li>Duel <img src="duel.png"></li>
<li>Gatling <img src="gatling.png"></li>
<li>General Store <img src="generalstore.png"></li>
<li>Indians <img src="indians.png"></li>
<li>Missed <img src="missed.png"></li>
<li>Panic <img src="panic.png"></li>
<li>Saloon <img src="saloon.png"></li>
<li>Stagecoach <img src="stagecoach.png"></li>
<li>Wells Fargo <img src="wellsfargo.png"></li>
</ol>
<h2>Others</h2>
<ol>
<li>Hand or card in hand <img src="card.png"></li>
<li>Draw from Discard <img src="cardface.png"></li>
<li>Create/Start game/finish discarding 2 for life/finish playing 2 misses <img src="ok.png"></li>
<li>Do not respond/finished play phase <img src="discard.png"></li>
<li>Gun <img src="gun.png"></li>
<li>Player <img src="player.png"></li>
<li>Join Game <img src="join.png"></li>
</ol>
</div>
</div>
<script language="javascript">
   function getServletUrl(){
       return "/bang/chat";
   }

   function initRequest() {
       if (window.XMLHttpRequest) {
	   return new XMLHttpRequest();
       } else if (window.ActiveXObject) {
	   isIE = true;
	   return new ActiveXObject("Microsoft.XMLHTTP");
       }
   }

   function sendXMLHttp(url, responseHandler){
	var req = initRequest();
	req.onreadystatechange = function() {
	   if (req.readyState == 4) {
		   if (req.status == 200) {
			   responseHandler(req.responseXML);
		   } else if (req.status == 204){
			   alert('error');
		   }
	   }
	};
	req.open("GET", url, true);
	req.send(null);
   }

	var gameStateResult = null;

   function parseGetGameState(responseXML) {
	var gameStateDiv = document.getElementById('gameState');
	if(gameStateDiv != null){
		var result = "";
		var deckSize = responseXML.getElementsByTagName("decksize")[0];
		if(deckSize == undefined){
			return;
		} else {
			started = true;
			var gameMessagesDiv = document.getElementById('gameMessages');
			gameMessagesDiv.style.display = "block";
			setup();
		}
		var size = deckSize.childNodes[0].nodeValue;
		if(size > 0){
			result += '<img id="draw_pile" src="card.png" alt="Draw pile" title="' + size + '">';
		}

		var discardCard = responseXML.getElementsByTagName("discardtopcard")[0];
		if(discardCard != null){
			var discardName = discardCard.getElementsByTagName("name")[0];
			var cardName = discardName.childNodes[0].nodeValue;
			result += '<img id="discard_pile" src="' + getImageForCard(cardName) + '" alt="Discard pile" title="' + cardName + '">';
		}

		var currentName = responseXML.getElementsByTagName("currentname")[0];
		var name = currentName.childNodes[0].nodeValue;

		var gameOverNode = responseXML.getElementsByTagName("gameover")[0];
		if(gameOverNode != null){
			result += 'Game Over <a href="/bang">Game Lobby</a>';
			gameOver = true;
		}
		var playerNodes = responseXML.getElementsByTagName("player");

		var foundSelf = false;
		for(var playerIndex = 0; playerIndex < playerNodes.length; playerIndex++){
			var loopPlayerName = playerNodes[playerIndex].getElementsByTagName("name")[0].childNodes[0].nodeValue;
			if(loopPlayerName == playerName){
				foundSelf = true;
			}
		}
		if(foundSelf == false && playerName != null){;
			result += "You dead";
		}

		for(var playerIndex = 0; playerIndex < playerNodes.length; playerIndex++){
			result += '<div>';
			var loopPlayerName = playerNodes[playerIndex].getElementsByTagName("name")[0].childNodes[0].nodeValue;
			var border_color = "FFF";
			if(loopPlayerName == playerName && name == loopPlayerName){
				border_color = "F0F";
			} else if(name == loopPlayerName){
				border_color = "F00";
			} else if(loopPlayerName == playerName){
				border_color = "00F";
			}
			result += '<img src="' + getImageForPlayer(loopPlayerName) + '" alt="Player" id="' + loopPlayerName + '" title="' + loopPlayerName + '" style="border:2px solid #' + border_color + '; opacity:0.6;">';
			if(playerNodes[playerIndex].getElementsByTagName("issheriff")[0] != null){
				result += '<img src="sheriff.png" alt="Role Sheriff">';
			} else {
				if(playerName == loopPlayerName){
					result += getImageForRole(role, goal);
				}
			}
			var playerHealth = playerNodes[playerIndex].getElementsByTagName("health")[0].childNodes[0].nodeValue;
			var playerMaxHealth = playerNodes[playerIndex].getElementsByTagName("maxhealth")[0].childNodes[0].nodeValue;
			for(var healthIndex = 0; healthIndex < playerHealth; healthIndex++){
				result += '<img src="vbullet.png" alt="Health token">';
			}
			for(var maxHealthIndex = healthIndex; maxHealthIndex < playerMaxHealth; maxHealthIndex++){
				result += '<img src="vemptybullet.png" alt="Health token">';
			}
			var handSize = playerNodes[playerIndex].getElementsByTagName("handsize")[0].childNodes[0].nodeValue;
			for(var handIndex = 0; handIndex < handSize; handIndex++){
				result += '<img src="card.png" alt="Hand card">'
			}
			var gunNode = playerNodes[playerIndex].getElementsByTagName("gun")[0];
			if(gunNode != null){
				var gunName = gunNode.getElementsByTagName("name")[0].childNodes[0].nodeValue;
				result += '<img src="' + getImageForCard(gunName) + '" alt="Gun" title="' + gunName + '">';
			}
			var inPlayNodes = playerNodes[playerIndex].getElementsByTagName("inplaycard");
			for(var inPlayIndex = 0; inPlayIndex < inPlayNodes.length; inPlayIndex++){
				var inPlayName = inPlayNodes[inPlayIndex].getElementsByTagName("name")[0].childNodes[0].nodeValue;
				result += '<img src="' + getImageForCard(inPlayName) + '" alt="In Play" title="' + inPlayName + '">';
			}
			result += '</div>';
		}
		if(gameStateResult != result){
			gameStateResult = result;
			gameStateDiv.innerHTML = result;
		}
	}
   }

   function formatMessage(message){
   	var result = "";
		if(message.indexOf("-") != -1){
			var splitMessage = message.split("-");
			var name = splitMessage[0];
			var commandData = splitMessage[1];
			var commandIndex = commandData.indexOf(" ");
			if(commandIndex != -1){
				var command = commandData.substring(0, commandIndex);
				result += '<h2>' + commandName(command) + '</h2>';
				var data = commandData.substring(commandIndex + 1);
				var splitData = data.split(", ");
				if(command.indexOf("chooseTwoDiscardForLife") != -1){
					result += "<img src='ok.png' alt='ok' onClick='sendResponse(selected);'>";
					for(var i = 0; i < splitData.length; i++){
						if(splitData[i] != ""){
							var image = getImageForCard(splitData[i]);
							result += '<img src="' + image + '" alt="Keep" title="' + splitData[i] + '" id="result' + i + '" onClick="document.getElementById(\'result' + i + '\').style.display = \'none\'; document.getElementById(\'discard' + i + '\').style.display = \'inline\'; selected += \'' + i + ',\';")>';
							result += '<img src="card.png" style="display:none;" alt="Discard" title="' + splitData[i] + '" id="discard' + i + '" onClick="document.getElementById(\'discard' + i + '\').style.display = \'none\'; document.getElementById(\'result' + i + '\').style.display = \'inline\'; selected = selected.replace(\',' + i + ',\', \',\');")>';
						}
					}
				} else if(command.indexOf("respondTwoMiss") != -1){
					result += "<img src='ok.png' alt='ok' onClick='sendResponse(selected);'>";
					for(var i = 0; i < splitData.length; i++){
						if(splitData[i] != ""){
							var nameCanPlaySplit = splitData[i].split("@");
							var cardName = nameCanPlaySplit[0];
							var canPlay = nameCanPlaySplit[1];
							var image = getImageForCard(cardName);
							if(canPlay.indexOf("false") != -1){
								result += '<img src="' + image + '" alt="Can not play" title="' + splitData[i] + '" id="result' + i + '" style="opacity:0.4;">';
							} else {
								result += '<img src="' + image + '" alt="Keep" title="' + splitData[i] + '" id="result' + i + '" onClick="document.getElementById(\'result' + i + '\').style.display = \'none\'; document.getElementById(\'discard' + i + '\').style.display = \'inline\';  selected += \'' + i + ',\';">';
								result += '<img src="card.png" style="display:none;" alt="Discard" title="' + splitData[i] + '" id="discard' + i + '" onClick="document.getElementById(\'discard' + i + '\').style.display = \'none\'; document.getElementById(\'result' + i + '\').style.display = \'inline\'; selected = selected.replace(\',' + i + ',\', \',\');">';
							}
						}
					}
				} else {
					if(command.indexOf("askOthersCard") != -1){
						if(splitData[0].indexOf("true") != -1){
							result += "<img src='card.png' width='100' alt='Players hand' onClick='sendResponse(-1);'>";
						}
						if(splitData[1].indexOf("true") != -1){
							result += "<img src='gun.png' width='100' alt='Players gun' onClick='sendResponse(-2);'>";
						}
						splitData = splitData.slice(2, splitData.length);
					} else if((command.indexOf("askPlay") != -1 && command.indexOf("askPlayer") == -1) || command.indexOf("respondBeer") != -1 || command.indexOf("respondBang") != -1 || command.indexOf("respondMiss") != -1){
						result += "<img src='discard.png' width='100' alt='Done Playing' onClick='sendResponse(-1);'>";
					}
					for(var i = 0; i < splitData.length; i++){
						var targetCode = "";
						var canPlay = true;
						if(command.indexOf("askPlay") != -1 || command.indexOf("respondBeer") != -1 || command.indexOf("respondBang") != -1 || command.indexOf("respondMiss") != -1){
							var canPlayTargets = splitData[i].split("@");
							splitData[i] = canPlayTargets[0];
							if(canPlayTargets.length == 3){
								if(canPlayTargets[1].indexOf("false") != -1){
									canPlay = false;
								} else {
									var targets = canPlayTargets[2];
									var splitTargets = targets.split("$");
									targetCode = generateTargetCode(splitTargets);

								}
							} else if(canPlayTargets.length == 2){
								if(canPlayTargets[1].indexOf("false") != -1){
									canPlay = false;
								}
							}
						}
						if("" != splitData[i].trim()){
							var image;
							var suit = null;
							var value = null;
							if(command.indexOf("askPlayer") != -1){
								image = getImageForPlayer(splitData[i]);
							} else {
								var cardName = splitData[i];
								image = getImageForCard(cardName);
								var suits = cardName.split("^");
								if(suits.length == 3){
									splitData[i] = suits[0];
									var suit = suits[1];
									var value = suits[2];
								}
							}
							if(canPlay){
								result += '<img src="' + image + '" alt="Action" title="' + splitData[i] + '" ' + targetCode + ' onClick="sendResponse(' + i + ');">';
							} else {
								result += '<img src="' + image + '" alt="Action" title="' + splitData[i] + '" ' + targetCode + ' style="opacity:0.4;">';
							}
							if(suit != null && value != null){
								result += value;
								if(suit == 'Clubs'){
									result += '<img src="clubs.png">';
								} else if(suit == 'Spades'){
									result += '<img src="spades.png">';
								} else if(suit == 'Hearts'){
									result += '<img src="hearts.png">';
								} else if(suit == 'Diamonds'){
									result += '<img src="diamonds.png">';
								}
							}
						}
					}
				}

			} else {
				result += '<h2>' + commandName(commandData) + '</h2>';
				if(commandData == "chooseFromPlayer"){
					result += "<img src='player.png' width='100' alt='Players hand' onClick='sendResponse(\"true\");'>";
				} else if(commandData == "chooseDiscard"){
					result += "<img src='cardface.png' width='100' alt='Discard Pile' onClick='sendResponse(\"true\");'>";
				}
				result += "<img src='card.png' width='100' alt='Draw Pile' onClick='sendResponse(\"false\");'>";
			}
		} else {
			var gameLogDiv = document.getElementById('gameLog');
			info = '<div>' + message + '</div>' + info;
			gameLogDiv.innerHTML = info;
			sendResponse("");
		}
   	return result;
   }

   function generateTargetCode(targets){
     var result = "";
     var mouseOver = 'onmouseover="';
     var mouseOut = 'onmouseout="';
     for(var i = 0; i < targets.length; i++){
       var target = targets[i];
       if(target != ""){
	       mouseOver += 'document.getElementById(\'' + target + '\').style.opacity = 1.0;';
	       mouseOut += 'document.getElementById(\'' + target + '\').style.opacity = 0.6;';
       }
     }
     mouseOver += '"';
     mouseOut += '"';
     return mouseOver + ' ' + mouseOut;
   }

   var info = "";


   function commandName(command){
   		if(command == "askDiscard"){
   			return "Discard";
   		} else if(command == "askOthersCard"){
   			return "From Other";
   		} else if(command == "askPlay"){
   			return "Play";
   		} else if(command == "askPlayer"){
   			return "Player";
   		} else if(command == "chooseCardToPutBack"){
   			return "Put Back";
   		} else if(command == "chooseDiscard"){
   			return "Draw Discard";
   		} else if(command == "chooseDrawCard"){
   			return "Draw Card";
   		} else if(command == "chooseFromPlayer"){
   			return "Draw Player";
   		} else if(command == "chooseGeneralStoreCard"){
   			return "Take";
   		} else if(command == "chooseTwoDiscardForLife"){
   			return "Discard for Life";
   		} else if(command == "respondBang"){
   			return "Bang";
   		} else if(command == "respondBeer"){
   			return "Beer";
   		} else if(command == "respondMiss"){
   			return "Miss";
   		} else if(command == "respondTwoMiss"){
   			return "2 Miss";
   		}
   }

   function getGameState(servletUrl, responseHandler, gameId) {
   	sendXMLHttp(servletUrl + "?messageType=GETGAMESTATE&gameId=" + gameId, responseHandler);
   }

   function parseCreate(responseXML){
		getAvailableGame(getServletUrl(), parseGetAvailableGame);
   }

   function create(servletUrl, responseHandler) {
      	sendXMLHttp(servletUrl + "?messageType=CREATE" , responseHandler);
   }

   function parseJoin(responseXML){
   	var userNode = responseXML.getElementsByTagName("user")[0];
   	if(userNode != null){
   		user = userNode.childNodes[0].nodeValue;
   		gameId = responseXML.getElementsByTagName("gameid")[0].childNodes[0].nodeValue;
   	}
   	writeInfo();
   	countPlayers(getServletUrl(), parseCountPlayers, gameId);
   }

   function join(servletUrl, responseHandler, gameId) {
      	sendXMLHttp(servletUrl + "?messageType=JOIN&gameId=" + gameId , responseHandler);
   }

   function parseLeave(responseXML){
   	var okNode = responseXML.getElementsByTagName("ok")[0];
	if(okNode != null){
		user = null;
		gameId = null;
		playerCount = null;
		previousAvailable = null;
		writeInfo();
		setup();
	}
   }

   function leave(servletUrl, responseHandler, user, gameId) {
      	sendXMLHttp(servletUrl + "?messageType=LEAVE&user=" + user + "&gameId=" + gameId, responseHandler);
   }

   function parseCountPlayers(responseXML){
   	playerCount = responseXML.getElementsByTagName("playercount")[0].childNodes[0].nodeValue;
   	canStart(getServletUrl(), parseCanStart, gameId);
   	setup();
   }

   function countPlayers(servletUrl, responseHandler, gameId) {
      	sendXMLHttp(servletUrl + "?messageType=COUNTPLAYERS&gameId=" + gameId, responseHandler);
   }

  function parseGetAvailableGame(responseXML){
		var gameNodes = responseXML.getElementsByTagName("game");
		availableGames = new Array();
		playerCounts = new Array();
		for(i = 0; i < gameNodes.length; i++){
			var availableGameId = gameNodes[i].getElementsByTagName("gameid")[0].childNodes[0].nodeValue;
			var availablePlayerCount = gameNodes[i].getElementsByTagName("playercount")[0].childNodes[0].nodeValue;
			availableGames.push(availableGameId);
			playerCounts.push(availablePlayerCount);
		}
		setup();
  }

  function getAvailableGame(servletUrl, responseHandler) {
		sendXMLHttp(servletUrl + "?messageType=AVAILABLEGAMES", responseHandler);
   }

   function parseCanStart(responseXML){
	var yesNode = responseXML.getElementsByTagName("yes")[0];
	if(yesNode != null){
		startable = true;
	} else {
		startable = false;
	}
	setup();
   }

   function canStart(servletUrl, responseHandler, gameId) {
      sendXMLHttp(servletUrl + "?messageType=CANSTART&gameId=" + gameId, responseHandler);
   }

   function parseStart(responseXML){
   		getGameState(getServletUrl(), parseGetGameState, gameId);
   }

   function start(servletUrl, responseHandler, gameId) {
      	sendXMLHttp(servletUrl + "?messageType=START&gameId=" + gameId, responseHandler);
   }

   var message = null;

   function parseGetMessage(responseXML){
      	var messageNode = responseXML.getElementsByTagName("message")[0];
      	var gameMessagesDiv = document.getElementById('gameMessages');
      	if(messageNode != null && goal != null){
      		var newMessage = messageNode.childNodes[0].nodeValue;
      		if(newMessage != message){
      			message = newMessage;
      			gameMessagesDiv.innerHTML = formatMessage(newMessage);
      		}
      	} else {
      		message = null;
      		gameMessagesDiv.innerHTML = "";
      	}

   }

   function getMessage(servletUrl, responseHandler, user, gameId) {
         sendXMLHttp(servletUrl + "?messageType=GETMESSAGE&user=" + user + "&gameId=" + gameId, responseHandler);
   }

   function parseSendResponse(responseXML){
	var okNode = responseXML.getElementsByTagName("ok")[0];
	if(okNode != null){
		var gameSetupDiv = document.getElementById('gameSetup');
		var result = "";
		gameSetupDiv.innerHTML = result;
		if(gameId != null){
			getMessage(getServletUrl(), parseGetMessage, user, gameId);
			getGameState(getServletUrl(), parseGetGameState, gameId);
		}
	}
   }

   function sendResponse(message){
   	sendResponseXML(getServletUrl(), parseSendResponse, user, message, gameId);
   }

   function sendResponseXML(servletUrl, responseHandler, user, response, gameId){
   	sendXMLHttp(servletUrl + "?messageType=SENDRESPONSE&user=" + user + "&response=" + response + "&gameId=" + gameId, responseHandler);
   }

   function parseSendChat(responseXML){
   	 getChat(getServletUrl(), parseGetChat);
   }

   function sendChat(servletUrl, responseHandler, chat){
      	sendXMLHttp(servletUrl + "?messageType=CHAT&chat=" + chat, responseHandler);
   }

  function parseGetChat(responseXML){
  	var chatLogDiv = document.getElementById('chatLog');
  	var chatNodes = responseXML.getElementsByTagName("chat");
  	var result = "";
	for(var i = 0; i < chatNodes.length; i++){
		if(chatNodes[i].childNodes.length > 0){
			result += '<p>' + chatNodes[i].childNodes[0].nodeValue + '</p>';
		}
	}
  	if(chatLogDiv.innerHTML != result){
  		chatLogDiv.innerHTML = result;
  	}
  }

  function getChat(servletUrl, responseHandler){
		sendXMLHttp(servletUrl + "?messageType=GETCHAT", responseHandler);
   }

   function parseGetPlayerInfo(responseXML){
	var nameNode = responseXML.getElementsByTagName("name")[0];
	if(nameNode != null){
		playerName = nameNode.childNodes[0].nodeValue;
	}
	var roleNode = responseXML.getElementsByTagName("role")[0];
	if(roleNode != null){
		role = roleNode.childNodes[0].nodeValue;
	}
	var goalNode = responseXML.getElementsByTagName("goal")[0];
	if(goalNode != null){
		goal = goalNode.childNodes[0].nodeValue;
	}
   }

   function getPlayerInfo(servletUrl, responseHandler, user, gameId) {
        sendXMLHttp(servletUrl + "?messageType=GETPLAYERINFO&user=" + user + "&gameId=" + gameId, responseHandler);
   }

   var user = null;
   var playerCount = null;
   var startable = null;
   var started = false;

   var playerName = null;
   var role = null;
   var goal = null;
   var selected = ",";
   var gameId = null;

   var gameOver = false;
   var availableGames = null;
   var playerCounts = null;
   var previousAvailable = null;

   function setup(){
   	var gameSetupDiv = document.getElementById('gameSetup');
   	var result = "";
   	if(!started){
		if(user == null){
			result += '<div><div><img src="ok.png" alt="Create" onClick="create(getServletUrl(), parseCreate);"></div><div>Create New Game</div></div>';
			var newAvailable = null;
			if(availableGames != null){
				newAvailable = "";
				for(var i = 0; i < availableGames.length; i++){
					newAvailable += '<div style="border:2px solid #000;"><div><div style="float:left;"><div><img src="join.png" alt="Join" onClick="join(getServletUrl(), parseJoin, ' + availableGames[i] + ');"></div><div>Join this game</div></div>';
					if(playerCounts[i] > 0){
						newAvailable += '<div style="float:left;">';
						for(var j = 0; j < playerCounts[i]; j++){
							newAvailable += '<img src="player.png" alt="Other Player">';
						}
						newAvailable += '<div>Players in game</div></div>';
					}
					newAvailable += '</div><div style="clear:both;"></div></div>';
				}
				result += newAvailable;
			}
			if(newAvailable != null){
				if(newAvailable == previousAvailable){
					return;
				} else {
					previousAvailable = newAvailable;
				}
			}
		} else {
			result += '<div><img src="discard.png" alt="Leave" onClick="leave(getServletUrl(), parseLeave, user, gameId);"></div><div>Leave this game</div>';
		}
		if(playerCount != null){
			result += '<div>';
			for(var i = 0; i < playerCount; i++){
				result += '<img src="player.png" alt="Other Player">';
			}
			result += '</div><div>Players in game</div>'
		}
		if(startable != null && startable == true){
			result += '<div><img src="card.png" onClick="start(getServletUrl(), parseStart, gameId);"></div><div>Start game</div>';
		}
   	}
   	if(gameSetupDiv.innerHTML != result){
   		gameSetupDiv.innerHTML = result;
   	}
   }

   function pollMessages(){
   	if(started){
		if(goal == null){
			getPlayerInfo(getServletUrl(), parseGetPlayerInfo, user, gameId);
		}
		getMessage(getServletUrl(), parseGetMessage, user, gameId);
	}
   }

   function timedCount()
   {
   	if(gameOver == false){
   		if(gameId != null){
        	getGameState(getServletUrl(), parseGetGameState, gameId);
        }
		var t=setTimeout("timedCount()",1000);
		setup();
		pollMessages();
		getChat(getServletUrl(), parseGetChat);
		writeInfo();
		if(!started){
			if(user == null){
				getAvailableGame(getServletUrl(), parseGetAvailableGame);
			}
			if(gameId != null){
				countPlayers(getServletUrl(), parseCountPlayers, gameId);
			}
		}
	}
   }

   function getImageForCard(cardName){
   	if(cardName.indexOf("Bang!") != -1){
   		return "bang.png";
   	} else if(cardName.indexOf("Missed!") != -1){
   		return "missed.png";
   	} else if(cardName.indexOf("Beer") != -1){
   		return "beer.png";
   	} else if(cardName.indexOf("Barrel") != -1){
   		return "barrel.png";
   	} else if(cardName.indexOf("Appaloosa") != -1){
   		return "appaloosa.png";
   	} else if(cardName.indexOf("Mustang") != -1){
   		return "mustang.png";
   	} else if(cardName.indexOf("Schofield") != -1){
   		return "schofield.png";
   	} else if(cardName.indexOf("Remington") != -1){
   		return "remington.png";
   	} else if(cardName.indexOf("Winchester") != -1){
   		return "winchester.png";
   	} else if(cardName.indexOf("Volcanic") != -1){
   		return "volcanic.png";
   	} else if(cardName.indexOf("Rev. Carbine") != -1){
   		return "carbine.png";
   	} else if(cardName.indexOf("Jail") != -1){
   		return "jail.png";
   	} else if(cardName.indexOf("Dynamite") != -1){
   		return "dynamite.png";
   	} else if(cardName.indexOf("Gatling") != -1){
   		return "gatling.png";
   	} else if(cardName.indexOf("Saloon") != -1){
   		return "saloon.png";
   	} else if(cardName.indexOf("Panic!") != -1){
   		return "panic.png";
   	} else if(cardName.indexOf("General Store") != -1){
   		return "generalstore.png";
   	} else if(cardName.indexOf("Indians!") != -1){
   		return "indians.png";
   	} else if(cardName.indexOf("Duel") != -1){
   		return "duel.png";
   	} else if(cardName.indexOf("Stagecoach") != -1){
   		return "stagecoach.png";
   	} else if(cardName.indexOf("Wells Fargo") != -1){
   		return "wellsfargo.png";
   	} else if(cardName.indexOf("Cat Balou") != -1){
   		return "catbalou.png";
   	} else {
   		return "cardface.png";
   	}
   }

	function writeInfo(){
		var gameInfoDiv = document.getElementById('gameInfo');
		if(gameId == null){
			gameInfoDiv.style.display = "block";
		} else {
			gameInfoDiv.style.display = "none";
		}
	}

   function getImageForPlayer(playerName){
   	if(playerName == "Bart Cassidy"){
   		return "bartcassidy.png";
   	} else if(playerName == "Black Jack"){
   		return "blackjack.png";
   	} else if(playerName == "Calamity Janet"){
   		return "calamityjanet.png";
   	} else if(playerName == "El Gringo"){
   		return "elgringo.png";
   	} else if(playerName == "Jesse Jones"){
   		return "jessejones.png";
   	} else if(playerName == "Jourdonnais"){
   		return "jourdonnais.png";
   	} else if(playerName == "Kit Carlson"){
   		return "kitcarlson.png";
   	} else if(playerName == "Lucky Duke"){
   		return "luckyduke.png";
   	} else if(playerName == "Paul Regret"){
   		return "paulregret.png";
   	} else if(playerName == "Pedro Ramirez"){
   		return "pedroramierz.png";
   	} else if(playerName == "Rose Doolan"){
   		return "rosedoolan.png";
   	} else if(playerName == "Sid Ketchum"){
   		return "sidketchum.png";
   	} else if(playerName == "Slab the Killer"){
   		return "slabthekiller.png";
   	} else if(playerName == "Suzy Lafayette"){
   		return "suzylafayette.png";
   	} else if(playerName == "Vulture Sam"){
   		return "vulturesam.png";
   	} else if(playerName == "Willy the Kid"){
   		return "willythekid.png";
   	} else {
   		return "player.png";
   	}
   }

   function getImageForRole(role, goal){
	if(role =="Sheriff"){
		return '<img src="sheriff.png" alt="Role sheriff" title="' + goal + '">';
	} else if(role == "Outlaw"){
		return '<img src="outlaw.png" alt="Role outlaw" title="' + goal + '">';
	} else if(role == "Deputy"){
		return '<img src="deputy.png" alt="Role deputy" title="' + goal + '">';
	} else if(role == "Renegade"){
		return '<img src="renegade.png" alt="Role renegade" title="' + goal + '">';
	}
   }

</script>
</body>
</html>